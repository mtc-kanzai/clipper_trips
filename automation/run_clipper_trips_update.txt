C:\Users\KAnzai\Documents\GitHub\clipper 
Info: Found credentials at: C:\Users\kanzai\Box\dvutils-creds-kanzai.json
drop table if exists baypass.anonymized_fare_transaction_subset;


-- Step 1: Filter fare transactions from January 2, 2024 onward
CREATE TABLE baypass.anonymized_fare_transaction_subset
DISTSTYLE KEY DISTKEY(anonymized_card_serial_number)
SORTKEY(ride_start_time_pst)
AS
SELECT
    aft.anonymized_card_serial_number,
    aft.ride_start_time_pst,
    aft.operator_id,
    aft.origin_location,
    aft.destination_location,
    aft.fare_transaction_sub_type,
    aft.route_id,
    aft.fare_category,
    aft.fare_discount,
    aft.purse_amount,
    aft.contract_id,
    aft.institution_id,
    CASE aft.fare_category
        WHEN 0 THEN 'Adult'
        WHEN 1 THEN 'Senior'
        WHEN 2 THEN 'RTC'
        WHEN 3 THEN 'Youth'
        ELSE 'Undefined'
    END AS fare_category_name
FROM clipper.anonymized_fare_transaction aft
LEFT JOIN clipper.clipper_coupon_contract_ids cc
    ON aft.contract_id = cc.id
WHERE aft.ride_start_time_pst >= TIMESTAMP '2024-01-02 00:00:00'
;


drop table if exists baypass.tagons;


-- Step 2: Separate tag-ons and tag-offs
SELECT * INTO TABLE baypass.tagons
FROM baypass.anonymized_fare_transaction_subset
WHERE fare_transaction_sub_type IN (1, 2, 4);


drop table if exists baypass.tagoffs;


-- Step 2: Separate tag-ons and tag-offs
SELECT * INTO TABLE baypass.tagoffs
FROM baypass.anonymized_fare_transaction_subset
WHERE fare_transaction_sub_type IN (3, 5);


drop table if exists baypass.complete_trips;


-- Step 3: Identify complete trips by matching tag-ons and tag-offs
SELECT f.*,
  CASE 
    WHEN f.fare_transaction_sub_type = 3 THEN n.purse_amount - f.purse_amount
    WHEN f.fare_transaction_sub_type = 5 THEN f.purse_amount
  END AS fare_charged
INTO TABLE baypass.complete_trips
FROM baypass.tagoffs as f
JOIN baypass.tagons as n ON f.anonymized_card_serial_number = n.anonymized_card_serial_number
  AND f.ride_start_time_pst = n.ride_start_time_pst;


drop table if exists baypass.tagoffs_only;


-- Step 4: Identify tag-offs without matching tag-ons
SELECT f.*,
  CASE 
    WHEN f.fare_transaction_sub_type = 3 THEN -f.purse_amount
    WHEN f.fare_transaction_sub_type = 5 THEN f.purse_amount
  END AS fare_charged
INTO TABLE baypass.tagoffs_only
FROM baypass.tagoffs as f
LEFT JOIN baypass.tagons as n ON f.anonymized_card_serial_number = n.anonymized_card_serial_number
  AND f.ride_start_time_pst = n.ride_start_time_pst
WHERE n.ride_start_time_pst IS NULL;


drop table if exists baypass.tagons_only;


-- Step 5: Identify tag-ons without matching tag-offs
SELECT n.*,
  n.purse_amount AS fare_charged
INTO TABLE baypass.tagons_only
FROM baypass.tagons as n
LEFT JOIN baypass.tagoffs as f ON f.anonymized_card_serial_number = n.anonymized_card_serial_number
  AND f.ride_start_time_pst = n.ride_start_time_pst
WHERE f.ride_start_time_pst IS NULL;


drop table if exists baypass.trips;


-- Step 6: Combine all trips into a unified table
SELECT t.*,
  EXTRACT(YEAR FROM t.ride_start_time_pst) AS fare_year,
  CASE WHEN EXTRACT(MONTH FROM t.ride_start_time_pst) > 6 THEN 7 ELSE 1 END AS fare_month
INTO TABLE baypass.trips
FROM (
  SELECT *, 'Tag-off Only' AS trip_type FROM baypass.tagoffs_only
  UNION
  SELECT *, 'Tag-on Only' AS trip_type FROM baypass.tagons_only
  UNION
  SELECT *, 'Tag-on and Tag-off' AS trip_type FROM baypass.complete_trips
) AS t;


drop table if exists baypass.transfers;


-- Step 7: Identify transfers (second tag-on within 2 hours of the first)
CREATE TABLE baypass.transfers AS
WITH trip1_enriched AS (
  SELECT
    trip1.anonymized_card_serial_number,
    -- Build the operator label once so we can reuse it downstream
    CASE 
      WHEN (op1.participant_name = 'Golden Gate Transit' AND rt.route_type = 'Marin Transit Route') THEN 'Marin Transit'
      WHEN (op1.participant_name = 'Napa Solano' AND rt.route_type IN ('FAST Local')) THEN 'FAST'
      WHEN (op1.participant_name = 'Napa Solano' AND rt.route_type IN ('Napa VINE 29 to BART', 'Napa VINE Express', 'Napa VINE Local')) THEN 'Napa Vine'
      WHEN (op1.participant_name = 'Napa Solano' AND rt.route_type IN ('SolTrans Express', 'SolTrans S82')) THEN 'SolTrans'
      WHEN (op1.participant_name = 'Napa Solano' AND rt.route_type = 'Vacaville Local') THEN 'Vacaville'
      WHEN (op1.participant_name = 'East Bay' AND rt.route_type LIKE 'County Connection%') THEN 'County Connection'
      WHEN (op1.participant_name = 'East Bay' AND rt.route_type LIKE 'TriDelta%') THEN 'Tri Delta'
      WHEN (op1.participant_name = 'East Bay' AND rt.route_type LIKE 'WestCAT%') THEN 'WestCAT'
      WHEN (op1.participant_name = 'East Bay' AND rt.route_type = 'Wheels Local') THEN 'Wheels'
      WHEN (op1.participant_name = 'Corridor 101' AND rt.route_type = 'Petaluma Transit Local Route') THEN 'Petaluma'
      WHEN (op1.participant_name = 'Corridor 101' AND rt.route_type = 'Santa Rosa City Bus Local Route') THEN 'Santa Rosa'
      ELSE op1.participant_name
    END AS trip_1_operator,
    trip1.ride_start_time_pst AS trip_1_tag_on_time,
    COALESCE(loc1.location_name, 'Unknown') AS trip_1_origin_location_name,
    COALESCE(loc2.location_name, 'Unknown') AS trip_1_destination_location_name
  FROM baypass.tagons AS trip1
  LEFT JOIN clipper.participant AS op1
    ON op1.participant_id = trip1.operator_id
  LEFT JOIN clipper.location AS loc1
    ON loc1.participant_id = trip1.operator_id
   AND loc1.location_code = trip1.origin_location
  LEFT JOIN clipper.location AS loc2
    ON loc2.participant_id = trip1.operator_id
   AND loc2.location_code = trip1.destination_location
  LEFT JOIN clipper.route AS route1
    ON route1.particpant_id = trip1.operator_id        -- to do: fix typo: participant_id
   AND route1.route_id = trip1.route_id
  LEFT JOIN clipper.routename_routetype AS rt
    ON rt.participant_name = op1.participant_name
   AND (rt.route_name = route1.route_name OR (rt.route_name IS NULL AND route1.route_name IS NULL))
),
candidate_pairs AS (
  SELECT
    e.anonymized_card_serial_number,
    e.trip_1_operator,
    e.trip_1_tag_on_time,
    e.trip_1_origin_location_name,
    e.trip_1_destination_location_name,
    trip2.ride_start_time_pst AS trip_2_tag_on_time,
    ttr.allowable_transfer_time,
    ROW_NUMBER() OVER (
      PARTITION BY e.anonymized_card_serial_number, e.trip_1_tag_on_time
      ORDER BY trip2.ride_start_time_pst ASC
    ) AS rn_next
  FROM trip1_enriched e
  JOIN baypass.tagons AS trip2
    ON trip2.anonymized_card_serial_number = e.anonymized_card_serial_number
   AND trip2.ride_start_time_pst > e.trip_1_tag_on_time
  LEFT JOIN baypass.transfer_time_rules AS ttr
    ON ttr.operator_transferred_from = e.trip_1_operator
  WHERE trip2.ride_start_time_pst <
        e.trip_1_tag_on_time + (CAST(ttr.allowable_transfer_time AS INT) || ' minutes')::interval
)
SELECT
  anonymized_card_serial_number,
  trip_1_operator,
  trip_1_tag_on_time,
  trip_2_tag_on_time,
  trip_1_origin_location_name,
  trip_1_destination_location_name,
  allowable_transfer_time,
  1 AS transfer_flag
FROM candidate_pairs
WHERE rn_next = 1;


drop table if exists baypass.clipper_trips;


-- Step 8: Enrich trips with metadata and transfer flags
CREATE TABLE baypass.clipper_trips AS

WITH base AS (
  SELECT
    t.anonymized_card_serial_number,
    t.ride_start_time_pst,
    t.trip_type,
    t.fare_discount,
    t.fare_charged,
    t.fare_category_name,
    t.institution_id,
    -- Compute operator_name (formerly SELECT alias)
    CASE 
      WHEN (p.participant_name = 'Golden Gate Transit' AND rt.route_type = 'Marin Transit Route') THEN 'Marin Transit'
      WHEN (p.participant_name = 'Napa Solano' AND rt.route_type IN ('FAST Local')) THEN 'FAST'
      WHEN (p.participant_name = 'Napa Solano' AND rt.route_type IN ('Napa VINE 29 to BART', 'Napa VINE Express', 'Napa VINE Local')) THEN 'Napa Vine'
      WHEN (p.participant_name = 'Napa Solano' AND rt.route_type IN ('SolTrans Express', 'SolTrans S82')) THEN 'SolTrans'
      WHEN (p.participant_name = 'Napa Solano' AND rt.route_type = 'Vacaville Local') THEN 'Vacaville'
      WHEN (p.participant_name = 'East Bay' AND rt.route_type LIKE 'County Connection%') THEN 'County Connection'
      WHEN (p.participant_name = 'East Bay' AND rt.route_type LIKE 'TriDelta%') THEN 'Tri Delta'
      WHEN (p.participant_name = 'East Bay' AND rt.route_type LIKE 'WestCAT%') THEN 'WestCAT'
      WHEN (p.participant_name = 'East Bay' AND rt.route_type = 'Wheels Local') THEN 'Wheels'
      WHEN (p.participant_name = 'Corridor 101' AND rt.route_type = 'Petaluma Transit Local Route') THEN 'Petaluma'
      WHEN (p.participant_name = 'Corridor 101' AND rt.route_type = 'Santa Rosa City Bus Local Route') THEN 'Santa Rosa'
      ELSE p.participant_name
    END AS operator_name,

    COALESCE(l1.location_name, 'Unknown') AS origin_location_name,
    COALESCE(l2.location_name, 'Unknown') AS destination_location_name,

    prod.description AS product_name,
    CASE WHEN t.contract_id IN (SELECT id FROM clipper.clipper_coupon_contract_ids) THEN 1 ELSE 0 END AS start_flag,
    CASE WHEN t.contract_id = 520 THEN 1 ELSE 0 END AS baypass_flag,
    COALESCE(rt.route_name, 'N/A') AS route_name,
    COALESCE(rt.route_type, 'N/A') AS route_type_name,

    -- Precompute estimated_adult_fare to reference later
    ft.adult_fare AS estimated_adult_fare,

    -- Bring transfer context
    tr.transfer_flag,
    tr.trip_1_operator AS operator_transferred_from,
    tr.trip_1_origin_location_name,
    tr.trip_1_destination_location_name
  FROM baypass.trips AS t
  LEFT JOIN clipper.participant AS p
    ON t.operator_id = p.participant_id
  LEFT JOIN clipper.location AS l1
    ON t.operator_id = l1.participant_id
   AND t.origin_location = l1.location_code
  LEFT JOIN clipper.location AS l2
    ON t.operator_id = l2.participant_id
   AND t.destination_location = l2.location_code
  LEFT JOIN clipper.contract_prodtype_map AS cp
    ON t.contract_id = cp.contract_type
  LEFT JOIN clipper.product AS prod
    ON prod.issuer_id = cp.issuer_id
   AND prod.product_type = cp.product_type
  LEFT JOIN clipper.route AS r
    ON t.operator_id = r.particpant_id           -- to do: fix typo
   AND t.route_id = r.route_id
  LEFT JOIN clipper.routename_routetype AS rt
    ON rt.participant_name = p.participant_name
   AND (rt.route_name = r.route_name OR (rt.route_name IS NULL AND r.route_name IS NULL))
  LEFT JOIN baypass.fare_table AS ft
    ON ft.operator         = p.participant_name
   AND ft.origin_location  = COALESCE(l1.location_name, '0')
   AND ft.destination_location = COALESCE(l2.location_name, '0')
   AND ft.route_type       = COALESCE(rt.route_type, '0')
   AND ft.fare_year        = COALESCE(t.fare_year, 0)
   AND ft.fare_month       = COALESCE(t.fare_month, 0)
  LEFT JOIN baypass.transfers AS tr
    ON t.ride_start_time_pst = tr.trip_2_tag_on_time
   AND t.anonymized_card_serial_number = tr.anonymized_card_serial_number
)
SELECT
  b.anonymized_card_serial_number,
  b.ride_start_time_pst,
  b.trip_type,
  b.fare_discount,
  b.fare_charged,
  b.fare_category_name,
  b.institution_id,
  b.operator_name,
  b.origin_location_name,
  b.destination_location_name,
  b.product_name,
  b.start_flag,
  b.baypass_flag,
  b.route_name,
  b.route_type_name,
  b.estimated_adult_fare,
  COALESCE(b.transfer_flag, 0) AS transfer_flag,
  b.operator_transferred_from,

  -- inter-operator / intra-operator flags based on operator names
  CASE WHEN b.transfer_flag IS NOT NULL AND b.operator_transferred_from <> b.operator_name THEN 1 ELSE 0 END AS interop_transfer_flag,
  CASE WHEN b.transfer_flag IS NOT NULL AND b.operator_transferred_from =  b.operator_name THEN 1 ELSE 0 END AS intraop_transfer_flag,

  -- Use real <> operator, and reference aliases from the CTE
  CASE
    WHEN b.transfer_flag IS NOT NULL
      THEN COALESCE(
             CASE WHEN b.trip_1_destination_location_name <> 'Unknown'
                  THEN b.trip_1_destination_location_name END,
             b.origin_location_name
           )
    ELSE NULL
  END AS transfer_location,

  b.trip_1_origin_location_name,
  b.trip_1_destination_location_name,

  -- Join transfer discount rules *after* operator_name is available
  -- and compute discount and net fare
  (CASE
     WHEN tdr.transfer_discount_available IS NULL THEN 0
     ELSE cast(tdr.transfer_discount_available as integer) * COALESCE(b.estimated_adult_fare, 0)
   END) AS estimated_transfer_discount,

  COALESCE(b.estimated_adult_fare, 0)
    - (CASE
         WHEN tdr.transfer_discount_available IS NULL THEN 0
         ELSE cast(tdr.transfer_discount_available as integer) * COALESCE(b.estimated_adult_fare, 0)
       END) AS estimated_adult_fare_with_transfers

FROM base AS b
LEFT JOIN baypass.transfer_discount_rules AS tdr
  ON tdr.operator_transferred_from = b.operator_transferred_from
 AND tdr.operator_transferred_to   = b.operator_name
;


drop table if exists baypass.anonymized_fare_transaction_subset;


drop table if exists baypass.tagons;


drop table if exists baypass.tagoffs;


drop table if exists baypass.complete_trips;


drop table if exists baypass.tagoffs_only;


drop table if exists baypass.tagons_only;


drop table if exists baypass.trips;


drop table if exists baypass.transfers;


grant select on baypass.trip_level_data to eps_user, eps_admin, kanzai, tableau_baypass;


